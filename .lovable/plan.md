

# SmartPay Full Backend Implementation

## Overview
Enable Lovable Cloud and build a complete backend for the SmartPay finance app, covering authentication, database, and an AI-powered coach — all wired into the existing frontend screens.

---

## Phase 1: Enable Lovable Cloud
Set up the managed Supabase backend (database, auth, edge functions) with zero external accounts.

---

## Phase 2: Authentication (Sign Up / Login / Logout)

### What changes
- **New pages**: `AuthPage.tsx` with email/password login and signup forms
- **Auth context**: A React context (`AuthProvider`) wrapping the app to manage session state via `onAuthStateChange`
- **Route protection**: Redirect unauthenticated users to the auth page; authenticated users go to the main app
- **Profile screen**: The "Log Out" button will call `supabase.auth.signOut()`
- **Redirect URL**: Sign-up will use `emailRedirectTo: window.location.origin`

### Database
- **profiles table**: `id (uuid, FK to auth.users)`, `name (text)`, `email (text)`, `avatar_url (text)`, `created_at`
- **Trigger**: Auto-create a profile row on user signup
- **RLS**: Users can only read/update their own profile

---

## Phase 3: Database Tables

### Tables to create

| Table | Key Columns | Purpose |
|-------|------------|---------|
| `profiles` | id, name, email, avatar_url | User profile data |
| `transactions` | id, user_id, merchant, amount, category, icon, time, created_at | Spending history |
| `budgets` | id, user_id, category, emoji, spent, budget_limit, period | Budget tracking |
| `contacts` | id, user_id, name, avatar, color | Pay contacts |

### Security
- All tables have RLS enabled
- All policies scope data to `auth.uid() = user_id`
- Seed data inserted for new users via a database trigger or on first login

### Frontend changes
- Replace all mock data imports with Supabase queries using TanStack Query (`useQuery` / `useMutation`)
- HomeScreen, PayScreen, InsightsScreen, ProfileScreen will fetch real data
- PayScreen will insert a transaction record on successful payment

---

## Phase 4: AI-Powered Coach (Lovable AI)

### Edge function: `supabase/functions/chat/index.ts`
- Accepts conversation messages from the client
- Prepends a system prompt tailored to a financial coaching assistant
- Calls the Lovable AI Gateway (`google/gemini-3-flash-preview`) with streaming enabled
- Handles 429 (rate limit) and 402 (payment required) errors gracefully
- Returns SSE stream to the client

### Frontend changes (CoachScreen)
- Remove mock `coachResponses` — replace with real AI streaming
- Send full conversation history to the edge function
- Render assistant tokens as they arrive (token-by-token streaming)
- Quick prompts still work but send real messages to the AI
- Show toast on rate limit or payment errors

---

## Phase 5: Insights (Computed from Real Data)

### Edge function: `supabase/functions/insights/index.ts`
- Accepts a `period` parameter (today / week / month)
- Queries the `transactions` table, aggregates by category and day/week
- Returns the same shape as the current `insightData` mock object
- Budget progress is computed from `budgets` table

### Frontend changes
- InsightsScreen fetches from the insights edge function instead of using mock data

---

## Summary of Files Created / Modified

### New files
- `src/pages/AuthPage.tsx` — Login / Signup UI
- `src/contexts/AuthContext.tsx` — Session management
- `src/integrations/supabase/client.ts` — Supabase client (auto-generated by Lovable Cloud)
- `supabase/functions/chat/index.ts` — AI coach edge function
- `supabase/functions/insights/index.ts` — Insights aggregation edge function
- Database migrations for profiles, transactions, budgets, contacts tables + RLS + triggers

### Modified files
- `src/App.tsx` — Add AuthProvider, protected routes
- `src/pages/Index.tsx` — Use auth context for user data
- `src/screens/HomeScreen.tsx` — Fetch real transactions and spending
- `src/screens/PayScreen.tsx` — Insert transactions, fetch contacts
- `src/screens/InsightsScreen.tsx` — Fetch aggregated data
- `src/screens/CoachScreen.tsx` — Real AI streaming
- `src/screens/ProfileScreen.tsx` — Real profile data, working logout
- `src/screens/HubScreen.tsx` — (Articles remain static for now, no backend needed)

